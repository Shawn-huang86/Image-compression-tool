(function(){"use strict";function U(i){const e=new DataView(i);if(e.getUint16(0,!1)!==65496)return 1;const a=e.byteLength;let t=2;for(;t<a;){const n=e.getUint16(t,!1);if(t+=2,n===65505){if(t+=2,e.getUint32(t,!1)===1165519206){const g=t+6,r=e.getUint16(g,!1)===18761,c=e.getUint32(g+4,r),f=e.getUint16(g+c,r);for(let h=0;h<f;h++){const m=g+c+2+h*12;if(e.getUint16(m,r)===274)return e.getUint16(m+8,r)}}break}else{if((n&65280)!==65280)break;t+=e.getUint16(t,!1)}}return 1}function D(i,e,a){const{width:t,height:n}=i;switch(a){case 2:e.transform(-1,0,0,1,t,0);break;case 3:e.transform(-1,0,0,-1,t,n);break;case 4:e.transform(1,0,0,-1,0,n);break;case 5:i.width=n,i.height=t,e.transform(0,1,1,0,0,0);break;case 6:i.width=n,i.height=t,e.transform(0,1,-1,0,n,0);break;case 7:i.width=n,i.height=t,e.transform(0,-1,-1,0,n,t);break;case 8:i.width=n,i.height=t,e.transform(0,-1,1,0,0,t);break}}async function B(i){try{const{id:e,imageData:a,filename:t,options:n}=i,{quality:g,maxWidth:r,maxHeight:c,format:f}=n,h=new Blob([a]),m=await createImageBitmap(h),l=U(a);let{width:s,height:o}=m;const O=s,z=o;if(s>r||o>c){const k=Math.min(r/s,c/o);s=Math.round(s*k),o=Math.round(o*k)}const w=l>4,p=w?o:s,b=w?s:o,d=new OffscreenCanvas(p,b),u=d.getContext("2d");D(d,u,l),u.drawImage(m,0,0,s,o);const I=f==="png"?"image/png":f==="webp"?"image/webp":"image/jpeg",y=await(await d.convertToBlob({type:I,quality:f==="png"?void 0:g})).arrayBuffer();return{id:e,success:!0,originalSize:a.byteLength,compressedSize:y.byteLength,originalDimensions:{width:O,height:z},compressedDimensions:{width:p,height:b},compressedData:y,filename:t}}catch(e){return{id:i.id,success:!1,originalSize:0,compressedSize:0,originalDimensions:{width:0,height:0},compressedDimensions:{width:0,height:0},filename:i.filename,error:e instanceof Error?e.message:"Unknown error"}}}self.onmessage=async i=>{const e=await B(i.data);self.postMessage(e)}})();
